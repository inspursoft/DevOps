# CD-TM-TH-HM-L2-01-测试分层方法设计文档


<table border="0" bordercolor="#FFFFFF">
  <tr>
    <th><img alt="title pic" src="../../docs/imgs/DevOps流程/DevOps_Gears.png"></th>
    <th><h1 style="font-size:150%">能力项  [测试分层策略]</h1></th>
  </tr>
</table>


# 前言

本文主要介绍掌上网管系统的微服务架构如何做分层自动化测试，以及分层自动化测试的价值所在。阐述的内容主要覆盖核心系统的分层自动化测试层次和方法。

# 目的

准备上生产环境的软件在上生产之前需要进行测试。随着软件开发行业的成熟，软件测试方法也日趋成熟。开发团队正在逐渐自动化大部分的测试，以此取代大量测试人员手工测试。通过自动化测试，开发团队可以分分钟就知道他们的软件是否被破坏，而不是后知后觉几天后才知道。自动化测试极大地缩短了反馈周期，这与敏捷开发实践、持续集成、DevOps 文化等是一脉相承的。拥有高效的软件测试方法，可以让你的团队快速而自信地前行。当然测试结果不是最终目的，而是要打通整个软件生命周期的全程软件测试流程。

# 金字塔分层模型

在敏捷方法中，持续集成是其基石，持续集成的核心是自动化测试。测试金字塔的概念来自Mike Cohn，在他的书《Succeeding with Agile》中有详细描述：测试金字塔最底层是单元测试，然后是业务逻辑测试，最后是端到端的测试（GUI或CLI）。

<img alt="测试分层策略" src="../../docs/imgs/DevOps流程/Testing Layer.png">

这个比喻非常形象，它让你一眼就知道测试是需要分层的。它还告诉你每一层需要写多少测试。

根据 Mike Cohn 的测试金字塔，建议测试组合应该由以下三层组成（自下往上分别是）：

- 单元测试

- 服务测试
- 用户界面测试

从具体项目的角度来看，测试金字塔似乎过于简单了，因此可能会产生误导。然而，由于其简洁性，在建立适合项目的测试组合时，测试金字塔本身是一条很好的经验法则。Cohn 测试金字塔中提到的两个原则是非常重要的：

- 编写不同粒度的测试

- 层次越高，编写的测试应该越少

为了维持金字塔形状，一个健康、快速、可维护的测试组合应该是这样的：写许多小而快的单元测试。适当写一些更粗粒度的测试，写很少高层次的端到端测试。注意不要让测试组合变成倒三角形，那对维护来说将是一个噩梦，并且跑一遍也需要太多时间。

不要太拘泥于 Cohn 测试金字塔中各层次的名字。事实上，它们可能相当具有误导性：服务测试是一个难以掌握的术语（Cohn 本人说他观察到很多开发人员完全忽略了这一层）。如果项目使用单页应用框架（如 react，angular，ember.js 等），UI 测试显然不必位于金字塔的最高层，完全能够用这些框架对 UI 进行单元测试。

考虑到原始名称的缺点，只要在代码库和团队中通过讨论中达成一致，完全可以为测试层次提供其他名称。

# 使用的工具和库

Junit：单元测试执行库

Swagger： 用于编写服务API接口测试

Sonarqube： 用于代码静态扫描和存储、分析静态扫描及单元测试的测试报告

Appium：用于编写手机端界面用户端到端测试

# 测试架构

<img alt="测试架构" src="../../docs/imgs/DevOps流程/Testing Process.png">

根据测试分层的策略，在测试环境中提供四种测试服务：

- 代码静态扫描：通过静态扫描的方式对代码的规范性和安全性进行测试并产生测试报告

- 单元测试：通过单元测试对代码库里的某个单元（被测试的主体）按照预期工作进行测试并生成单元测试报告和覆盖率

- API接口测试：通过API接口测试在服务调用时发送正确的请求，检测服务API是否正确地解析响应，生成API测试覆盖率

- 真机界面测试：通过真机UI 测试检测应用中的用户界面是否如预期工作。比如，用户的输入是否触发正确的动作，数据是否正确展示给用户，UI 的状态是否发生正确变化等

测试分层架构有以下几个关键点：

- 测试服务通过流水线进行串联，每个阶段设有质量门禁，测试质量未达标，代码不能进行提交合并

- 测试用例和测试配置代码化，同程序代码放入统一个项目中，统一进行版本管理

- 测试服务和测试对象以容器服务的方式加载及提供服务，按需使用

- 测试反馈（报告）需要和Issue及MR关联，方便检查查看

- 至于各层投入的具体比重，还是需要根据项目的需求来实际规划。在《google 测试之道》一书，对于google产品，70%的投入为单元测试，20%为集成、接口测试，10% 为UI层的自动化测试。
