

# CD-CM-VC-AM-L3-01-制品库使用与管理规范文档

<table border="0" bordercolor="#FFFFFF">
  <tr>
    <th><img alt="title pic" src="../../docs/imgs/DevOps流程/DevOps_Gears.png"></th>
    <th><h1 style="font-size:150%">能力项  [版本控制]</h1></th>
  </tr>
</table>

# 简介

> 本文档主要介绍了掌上网管项目的制品库 nexus 的使用。

# 前言

掌上网管项目的制品包有maven和docker两种，因此采用了nexus3作为其制品库。Nexus Repository OSS是一款通用的软件包仓库管理（Universal Repository Manager）服务，和许多商业开源软件类似，OSS版本是开源免费的。从3.X开始，它默认支持许多主流的软件包格式，能够满足我们多种包存储的需求，我们使用的是oss 3.16.1。

# 目的

使用nexus制品库，可以更好地管理不同种类的制品组件，对于人员的权限分配也十分方便。

# 服务使用

一、         安装

预制环境：docker环境

1.1      拉取docker镜像 ` docker pull docker.io/sonatype/nexus3:3.16.0`

1.2      启动容器，挂载存储目录：`docker run -d -p 8081:8081 --name nexus -v /some/dir/nexus-data:/nexus-data sonatype/nexus3`

二、     升级和迁移

​       容器化的服务升级直接更换镜像即可，迁移也是只需要将存储目录迁移。

# 用户界面

1. 搜索组件：

主工具栏中的`browse`按钮访问不同的搜索模式，然后选择`search`或其中一个嵌套选项，如`custom`  或`  Maven`。 搜索标题下方显示当前条件输入的搜索条件输入区域，除当前条件外，还有更多标准按钮，可让您为搜索添加更多条件。可以通过单击条件输入框中的`-`、`——`图标来删除每个条件。输入框中的`cross / x`将重置该值。

2. 浏览存储库和存储库组

存储库管理器最直接的用途之一是浏览。浏览允许您检查所有受支持的存储库格式的任何存储库或存储库组的内容。

单击主工具栏中的`browse`按钮以访问`浏览`功能。此功能允许您选择存储库或存储库组以从所有存储库列表中进行浏览。

单击特定存储库的行后，将显示包含存储库中所有资产的树。您可以过滤树内容，展开您感兴趣的节点，并选择组件或资产以获取更多详细信息。

3. 更改用户信息

作为登录用户，您可以单击主工具栏右侧的用户名切换主菜单以包含用户菜单。按压帐户菜单项显示的帐户在主功能面板功能，您可以编辑您的name，email、密码等信息。

4. 上传组件

通过UI，Nexus Repository Manager可以轻松地将这些第三方组件上传到任何托管存储库。

- **上传准备**
  1. 分配给用户的  nx-component-upload 特权（默认情况下，匿名用户没有此权限，但管理员可以）
  2. 一个或多个托管存储库（仅支持 Apt，Maven版本，npm，NuGet，PyPI，RubyGems，Raw 和Yum  存储库）
  3. 用户必须具有编辑存储库的权限。值得注意的是，如果用户具有浏览和读取权限，则用户仍将看到“上载”按钮，但是如果他们尝试上载文件，则会显示一条消息，表明他们未获得授权。
  4. 一个或多个适用于预期存储库格式的文件。

- **上传组件**

要将组件上载到存储库，请在`  browse`  功能中选择一个托管存储库，然后单击`upload` 按钮，然后按照指令选择要上传的文件。 

# 系统设置

本节介绍配置Nexus Repository Manager OSS的所有方面。特别是管理主菜单的部分和菜单项。授权用户可以通过按主工具栏中的`管理`按钮来访问它。

1、存储库

**Blob Stores：**

组件及其资产的二进制部分的内部存储机制。每个blob stores可以由一个或多个存储库和存储库组使用。新建的仓库将自动配置基于安装期间配置的数据目录中的文件系统存储的默认blob stores。

**Repository：**

创建新的仓库、对仓库进行信息配置，包括docker仓库的端口、https访问、blob store等

**Cleanup policies：**

清理策略，可以针对制品库中的制品进行自动清理设置，超过多少天不用的自动清理，或者是超过多少天没有更新的自动清理。

2、安全

**Privilege：**

权限控制对存储库管理器的特定功能的访问，并且可以分组为角色并分配给特定用户。

**Roles：**

角色将权限关联到相关上下文中，然后可以对其进行分组以创建更复杂的角色。存储库管理器附带预定义的管理员和匿名角色。可以在`roles`功能视图中检查这些内容。

要创建新角色，请单击“ 创建角色”按钮，选择“ Nexus角色”并填写“ 角色创建功能”视图。

除了创建内部角色之外，nexus还允许您创建外部角色映射到存储库管理器（如LDAP）中配置的外部授权系统。如果要在存储库管理器中授予外部管理组（例如LDAP组）的每个成员许多特权和角色，则可以执行此操作。

例如，假设您在LDAP中有一个名为group的组scm，并且您希望确保该scm 组中的每个人都 具有管理权限。选择`  外部角色映射`和`LDAP` 以查看该对话框中该外部域管理的角色列表。选择所需的scm组， 并按Create mapping确认。  

**User：**

默认情况下，存储库管理器附带两个用户：admin和anonymous。该管理员用户拥有所有权限和匿名用户只读权限。

单击列表中的用户或单击`  创建用户`  按钮将显示详细信息视图，以编辑或创建如图所示的帐户  ：`创建或编辑用户`。对于外部用户，例如LDAP或Crowd，一旦进行了外部域设置，您也可以在此处编辑其权限。只需从Source下拉列表中选择用户所在的领域即可  。然后在该下拉列表右侧的字段中键入  用户ID 并搜索它。然后单击要编辑的结果，与本地用户相同。

**Anonymous：**

默认情况下，未经身份验证的用户可以使用用户界面以及存储库和包含的组件进行读取访问。可通过` 管理`主菜单的` 安全性`部分中的` 匿名`项查看` 匿名`功能视图，如图  所示：`配置匿名访问`。

这些用户可用的权限由从NexusAuthorizingRole分配给匿名用户的角色控制  。通过在` 用户`功能视图中更改分配给该用户的权限。

**LDAP：**

Nexus Repository Manager可以使用轻量级目录访问协议（LDAP）通过提供LDAP支持的外部系统进行身份验证，例如Microsoft Exchange / Active Directory，OpenLDAP，ApacheDS等。 

除了处理身份验证之外，还可以将存储库管理器配置为将角色映射到LDAP用户组。如果用户是与角色ID匹配的LDAP组的成员，则存储库管理器会授予该用户匹配的角色。除了这种高度可配置的用户和组映射功能外，存储库管理器还可以使用特定的用户角色映射来扩充LDAP组成员资格。

存储库管理器可以缓存身份验证信息并支持多个LDAP服务器和用户/组映射。可以直接从用户界面测试LDAP服务器和用户/组映射的连接详细信息以及特定帐户登录。 

**Realms：**

安全领域管理的功能视图，允许您通过将用于身份验证和授权的安全领域添加到右侧的`活动`列表并将其置于列表的更高或更低位置来激活它们并确定其优先级。可以通过“ 管理”主菜单中“security”下的“realms”菜单项访问它。

**SSL certificate：**

使用与存储库管理器的安全套接字层（SSL）通信是一项重要的安全功能和推荐的最佳实践。安全通信可以是入站或出站。

3、支持

Log：支持查看系统日志，并且下载日志信息。

Metrics：可以查看总体数据，包括内存使用、web请求等。

Status：可以查看各个组件的运行状态好坏。

System information：系统的所有信息，包括状态、node、配置等

4、系统

API：查看系统的API。

Email server：配置邮箱服务。

Tasks：任务管理，可以用来执行定时任务，比如清理仓库、定时更新远程缓存等。

# 仓库格式

目前oss-nexus3支持的仓库格式有：browser、docker、gitlfs、maven、npm、NuGet、raw、PyPI、RubyGems、YUM 。

# REST和集成API

Nexus Repository Manager利用简单的UI界面从可用的端点生成全面的REST文档。REST API可用于将存储库管理器与外部系统集成。界面是完全交互式的，可以填写参数，并通过UI直接进行REST调用，以在浏览器中查看结果。

通过UI记录REST API端点和功能的完整列表。以下重点介绍了值得注意的功能：

搜索 - 组件搜索功能

资产 - 直接访问存储库中的资产/二进制文件和关联的元数据

组件 - 直接访问 存储库中文件的语言本机逻辑分组，例如 maven2 groupId，artifactId，version

脚本  - 用于配置和其他复杂任务

任务 - 存储库管理器的可用管理任务

# webhooks

Webhooks被定义为HTTP回调。简单来说，webhooks允许Nexus Repository Manager管理员配置基于HTTP的回调，以通知外部服务Nexus Repository Manager中发生的重要事件。

组织以多种方式使用webhook来进一步自动化其工作流程，并将第三方系统与关键服务集成。Nexus Repository Manager提供了将webhook用于全局审计，基于存储库的事件以及特定存储库上的事件的功能。

- 全局webhook：

点击`Capabilities`功能

点击`Create capability`按钮，创建新的capability 类型

选择`webhook：global`，创建全局的webhook

通过选择 要发送事件的事件类型来填写表单  ，输入您希望将事件发送到的URL。

 

# Docker镜像仓库

Docker镜像仓库有三个：release仓库、master仓库、devops 仓库。

release仓库：

作用：存放release分支编译的镜像。

路径：项目名称/项目镜像名：分支版本号

master仓库：

作用：存放master分支编译的镜像。

路径：项目名称/项目镜像名：分支版本号

devops仓库：

作用：存放dev分支进行ci测试并通过后产出的镜像。

路径：项目名称/项目镜像名：提交sha值得前8位。